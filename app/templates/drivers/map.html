{% extends 'base.html' %}
{% block title %}Mapa de Pedidos - AquaTrack{% endblock %}
{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tracking.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}
{% block content %}
<div class="map-container">
  <div class="page-header">
    <h1>üó∫Ô∏è Mapa de Mis Pedidos</h1>
    <div style="display: flex; gap: 1rem;">
      <a class="btn" href="{{ url_for('drivers.driver_dashboard') }}">üì¶ Ver Lista de Pedidos</a>
      <a class="btn btn-secondary" href="{{ url_for('main.dashboard') }}">üè† Volver</a>
      <button class="btn btn-success" id="calculateRoute" style="margin-left: auto;">üó∫Ô∏è Calcular Ruta √ìptima</button>
      <button class="btn btn-secondary" id="clearRoute">‚ùå Limpiar Ruta</button>
    </div>
    <hr>
  </div>

  <div id="map" style="width: 100%; height: 600px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); margin: 2rem 0;"></div>

  <div class="orders-legend" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 10px;">
    <h3>Leyenda</h3>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-top: 1rem;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #007bff; border-radius: 50%; display: inline-block;"></span>
        <span>Pendiente/Asignado</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #28a745; border-radius: 50%; display: inline-block;"></span>
        <span>Entregado</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%; display: inline-block;"></span>
        <span>Cancelado</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
  // Datos de pedidos desde el servidor
  const ordersData = {{ orders|tojson }};
  const depotsData = {{ depots|tojson if depots is defined else '[]' }};
  
  // Esperar a que el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    // Coordenadas de Cochabamba como centro por defecto
    const center = { lat: -17.3935, lng: -66.1570 };
    
    // Crear mapa usando Leaflet
    const map = L.map('map').setView([center.lat, center.lng], 13);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // Agregar marcadores para cada pedido
    if (ordersData && ordersData.length > 0) {
      ordersData.forEach(order => {
        let markerColor = '#007bff'; // Azul para pendiente/asignado
        if (order.status === 'delivered') {
          markerColor = '#28a745'; // Verde para entregado
        } else if (order.status === 'cancelled') {
          markerColor = '#dc3545'; // Rojo para cancelado
        }
        
        // Crear icono personalizado
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: ${markerColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });
        
        // Crear marcador
        const marker = L.marker([order.lat, order.lon], { icon: icon }).addTo(map);
        
        // Crear popup con informaci√≥n del pedido
        const popupContent = `
          <div style="min-width: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">Pedido #${order.id}</h4>
            <p style="margin: 0.25rem 0;"><strong>Cliente:</strong> ${order.client_name}</p>
            <p style="margin: 0.25rem 0;"><strong>Direcci√≥n:</strong> ${order.address || 'N/A'}</p>
            <p style="margin: 0.25rem 0;"><strong>Estado:</strong> ${order.status}</p>
            <p style="margin: 0.25rem 0;"><strong>Monto:</strong> Bs. ${order.total_amount}</p>
            ${order.delivery_date ? `<p style="margin: 0.25rem 0;"><strong>Entrega:</strong> ${order.delivery_date}</p>` : ''}
          </div>
        `;
        
        marker.bindPopup(popupContent);
      });
    } else {
      // Si no hay pedidos, mostrar mensaje
      map.setView([center.lat, center.lng], 13);
    }

    let routingControl = null;

    // Calcular ruta √≥ptima (desde almac√©n a pedidos visibles)
    const calcBtn = document.getElementById('calculateRoute');
    const clearBtn = document.getElementById('clearRoute');

    if (calcBtn) {
      calcBtn.addEventListener('click', async function() {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }

        const depot = depotsData && depotsData.length > 0 ? depotsData[0] : {lat: -17.3935, lon: -66.1570};

        const pendingOrders = ordersData.filter(o => o.status === 'pending' || o.status === 'assigned');
        if (!pendingOrders || pendingOrders.length === 0) {
          alert('No hay pedidos pendientes para calcular la ruta.');
          return;
        }

        // Intentar optimizar orden de waypoints con OSRM Trip API
        const coords = [
          [depot.lon, depot.lat],
          ...pendingOrders.map(o => [o.lon, o.lat])
        ];
        const coordsStr = coords.map(c => c.join(',')).join(';');
        const tripUrl = `https://router.project-osrm.org/trip/v1/driving/${coordsStr}?source=first&roundtrip=false&annotations=false`;

        try {
          const resp = await fetch(tripUrl);
          if (resp.ok) {
            const tripJson = await resp.json();
            if (tripJson.code === 'Ok' && tripJson.waypoints && tripJson.trips && tripJson.trips.length > 0) {
              const ordered = tripJson.waypoints
                .slice(1)
                .sort((a, b) => a.waypoint_index - b.waypoint_index)
                .map(wp => L.latLng(wp.location[1], wp.location[0]));

              routingControl = L.Routing.control({
                waypoints: [L.latLng(depot.lat, depot.lon), ...ordered],
                routeWhileDragging: false,
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'driving' }),
                createMarker: function(i, waypoint) {
                  if (i === 0) {
                    return L.marker(waypoint.latLng, {
                      icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: #6f42c1; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">üè≠</div>`,
                        iconSize: [35, 35],
                        iconAnchor: [17, 17]
                      })
                    });
                  }
                  return null;
                }
              }).addTo(map);
              return;
            }
          }
        } catch (err) {
          console.warn('OSRM trip optimization failed, falling back to simple order', err);
        }

        // Fallback: usar orden original
        const waypoints = pendingOrders.map(order => L.latLng(order.lat, order.lon));
        routingControl = L.Routing.control({
          waypoints: [L.latLng(depot.lat, depot.lon), ...waypoints],
          routeWhileDragging: false,
          router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'driving' }),
          createMarker: function(i, waypoint) {
            if (i === 0) {
              return L.marker(waypoint.latLng, {
                icon: L.divIcon({
                  className: 'custom-marker',
                  html: `<div style="background-color: #6f42c1; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">üè≠</div>`,
                  iconSize: [35, 35],
                  iconAnchor: [17, 17]
                })
              });
            }
            return null;
          }
        }).addTo(map);
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
      });
    }
  });
</script>
{% endblock %}
