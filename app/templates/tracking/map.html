{% extends 'base.html' %}
{% block title %}Mapa de Distribuci√≥n - AquaTrack{% endblock %}
{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tracking.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
{% endblock %}
{% block content %}
<div class="map-container">
  <div class="page-header">
    <h1>üó∫Ô∏è Mapa de Distribuci√≥n</h1>
    <p>Vista de mapa de Cochabamba. Aqu√≠ podr√°s ver la ubicaci√≥n de clientes, pedidos, almacenes y rutas de entrega.</p>
    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
      <a class="btn" href="{{ url_for('orders.list_orders') }}">üì¶ Ver Pedidos</a>
      <a class="btn" href="{{ url_for('clients.list_clients') }}">üë§ Ver Clientes</a>
      <a class="btn" href="{{ url_for('depots.list_depots') }}">üè≠ Almacenes</a>
      <a class="btn btn-secondary" href="{{ url_for('main.dashboard') }}">üè† Volver al Dashboard</a>
    </div>
    <hr>
    
    <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
      <h3 style="margin: 0 0 0.5rem 0;">Filtros y Opciones</h3>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" id="showOrders" checked> Mostrar Pedidos
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" id="showClients" checked> Mostrar Clientes
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" id="showDepots" checked> Mostrar Almacenes
        </label>
        <button class="btn btn-success" id="calculateRoute" style="margin-left: auto;">üó∫Ô∏è Calcular Ruta √ìptima</button>
        <button class="btn btn-secondary" id="clearRoute">‚ùå Limpiar Ruta</button>
      </div>
    </div>
  </div>

  <div id="map" style="width: 100%; height: 700px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); margin: 2rem 0;"></div>

  <div class="orders-legend" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 10px;">
    <h3>Leyenda</h3>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-top: 1rem;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #007bff; border-radius: 50%; display: inline-block;"></span>
        <span>Pedidos Pendientes/Asignados</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #28a745; border-radius: 50%; display: inline-block;"></span>
        <span>Pedidos Entregados</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%; display: inline-block;"></span>
        <span>Pedidos Cancelados</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #ffc107; border-radius: 50%; display: inline-block;"></span>
        <span>Clientes</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="width: 20px; height: 20px; background: #6f42c1; border-radius: 50%; display: inline-block;"></span>
        <span>Almacenes</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
  // Datos desde el servidor
  const ordersData = {{ orders|tojson }};
  const clientsData = {{ clients|tojson }};
  const depotsData = {{ depots|tojson }};
  
  let map;
  let orderMarkers = [];
  let clientMarkers = [];
  let depotMarkers = [];
  let routingControl = null;
  
  // Esperar a que el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    // Coordenadas de Cochabamba como centro por defecto
    const center = { lat: -17.3935, lng: -66.1570 };
    
    // Crear mapa usando Leaflet
    map = L.map('map').setView([center.lat, center.lng], 13);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // Funci√≥n para agregar marcadores de pedidos
    function addOrderMarkers() {
      if (!ordersData || ordersData.length === 0) return;
      
      ordersData.forEach(order => {
        let markerColor = '#007bff'; // Azul para pendiente/asignado
        if (order.status === 'delivered') {
          markerColor = '#28a745'; // Verde para entregado
        } else if (order.status === 'cancelled') {
          markerColor = '#dc3545'; // Rojo para cancelado
        }
        
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: ${markerColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">üì¶</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });
        
        const marker = L.marker([order.lat, order.lon], { icon: icon }).addTo(map);
        
        const popupContent = `
          <div style="min-width: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">Pedido #${order.id}</h4>
            <p style="margin: 0.25rem 0;"><strong>Cliente:</strong> ${order.client_name}</p>
            <p style="margin: 0.25rem 0;"><strong>Direcci√≥n:</strong> ${order.address || 'N/A'}</p>
            <p style="margin: 0.25rem 0;"><strong>Estado:</strong> ${order.status}</p>
            <p style="margin: 0.25rem 0;"><strong>Conductor:</strong> ${order.driver_name || 'Sin asignar'}</p>
            <p style="margin: 0.25rem 0;"><strong>Monto:</strong> Bs. ${order.total_amount}</p>
            ${order.delivery_date ? `<p style="margin: 0.25rem 0;"><strong>Entrega:</strong> ${order.delivery_date}</p>` : ''}
          </div>
        `;
        
        marker.bindPopup(popupContent);
        orderMarkers.push(marker);
      });
    }
    
    // Funci√≥n para agregar marcadores de clientes
    function addClientMarkers() {
      if (!clientsData || clientsData.length === 0) return;
      
      clientsData.forEach(client => {
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: #ffc107; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">üë§</div>`,
          iconSize: [25, 25],
          iconAnchor: [12, 12]
        });
        
        const marker = L.marker([client.lat, client.lon], { icon: icon }).addTo(map);
        
        const popupContent = `
          <div style="min-width: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">${client.name}</h4>
            <p style="margin: 0.25rem 0;"><strong>Direcci√≥n:</strong> ${client.address || 'N/A'}</p>
            ${client.phone ? `<p style="margin: 0.25rem 0;"><strong>Tel√©fono:</strong> ${client.phone}</p>` : ''}
          </div>
        `;
        
        marker.bindPopup(popupContent);
        clientMarkers.push(marker);
      });
    }
    
    // Funci√≥n para agregar marcadores de almacenes
    function addDepotMarkers() {
      if (!depotsData || depotsData.length === 0) return;
      
      depotsData.forEach(depot => {
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: #6f42c1; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">üè≠</div>`,
          iconSize: [35, 35],
          iconAnchor: [17, 17]
        });
        
        const marker = L.marker([depot.lat, depot.lon], { icon: icon }).addTo(map);
        
        const popupContent = `
          <div style="min-width: 200px;">
            <h4 style="margin: 0 0 0.5rem 0;">${depot.name}</h4>
            <p style="margin: 0.25rem 0;"><strong>Direcci√≥n:</strong> ${depot.address || 'N/A'}</p>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        depotMarkers.push(marker);
      });
    }
    
    // Agregar todos los marcadores inicialmente
    addOrderMarkers();
    addClientMarkers();
    addDepotMarkers();
    
    // Event listeners para filtros
    document.getElementById('showOrders').addEventListener('change', function(e) {
      orderMarkers.forEach(marker => {
        if (e.target.checked) {
          map.addLayer(marker);
        } else {
          map.removeLayer(marker);
        }
      });
    });
    
    document.getElementById('showClients').addEventListener('change', function(e) {
      clientMarkers.forEach(marker => {
        if (e.target.checked) {
          map.addLayer(marker);
        } else {
          map.removeLayer(marker);
        }
      });
    });
    
    document.getElementById('showDepots').addEventListener('change', function(e) {
      depotMarkers.forEach(marker => {
        if (e.target.checked) {
          map.addLayer(marker);
        } else {
          map.removeLayer(marker);
        }
      });
    });
    
    // Calcular ruta √≥ptima
    document.getElementById('calculateRoute').addEventListener('click', async function() {
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      // Obtener almac√©n (el primero disponible)
      const depot = depotsData && depotsData.length > 0 ? depotsData[0] : {lat: -17.3935, lon: -66.1570};
      
      // Obtener pedidos pendientes/asignados
      const pendingOrders = ordersData.filter(o => o.status === 'pending' || o.status === 'assigned');
      
      if (pendingOrders.length === 0) {
        alert('No hay pedidos pendientes para calcular la ruta.');
        return;
      }
      
      // Crear waypoints (optimizar orden usando OSRM Trip API)
      const coords = [
        [depot.lon, depot.lat],
        ...pendingOrders.map(o => [o.lon, o.lat])
      ];

      // Formatear coords para OSRM: lon,lat;lon,lat;...
      const coordsStr = coords.map(c => c.join(',')).join(';');
      const tripUrl = `https://router.project-osrm.org/trip/v1/driving/${coordsStr}?source=first&roundtrip=false&annotations=false`;

      try {
        const resp = await fetch(tripUrl);
        if (resp.ok) {
          const tripJson = await resp.json();
          if (tripJson.code === 'Ok' && tripJson.waypoints && tripJson.trips && tripJson.trips.length > 0) {
            // waypoints array indica el orden; el primer waypoint es el almac√©n (source=first)
            const ordered = tripJson.waypoints
              .slice(1) // quitar el primer waypoint (almac√©n)
              .sort((a, b) => a.waypoint_index - b.waypoint_index)
              .map(wp => L.latLng(wp.location[1], wp.location[0]));

            routingControl = L.Routing.control({
              waypoints: [L.latLng(depot.lat, depot.lon), ...ordered],
              routeWhileDragging: false,
              router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'driving' }),
              createMarker: function(i, waypoint) {
                if (i === 0) {
                  return L.marker(waypoint.latLng, {
                    icon: L.divIcon({
                      className: 'custom-marker',
                      html: `<div style="background-color: #6f42c1; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">üè≠</div>`,
                      iconSize: [35, 35],
                      iconAnchor: [17, 17]
                    })
                  });
                }
                return null;
              }
            }).addTo(map);
            return;
          }
        }
      } catch (err) {
        console.warn('OSRM trip optimization failed, falling back to simple order', err);
      }

      // Fallback: usar orden original si falla la optimizaci√≥n
      const waypoints = pendingOrders.map(order => L.latLng(order.lat, order.lon));
      routingControl = L.Routing.control({
        waypoints: [L.latLng(depot.lat, depot.lon), ...waypoints],
        routeWhileDragging: false,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'driving' }),
        createMarker: function(i, waypoint) {
          if (i === 0) {
            return L.marker(waypoint.latLng, {
              icon: L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: #6f42c1; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">üè≠</div>`,
                iconSize: [35, 35],
                iconAnchor: [17, 17]
              })
            });
          }
          return null;
        }
      }).addTo(map);
    });
    
    // Limpiar ruta
    document.getElementById('clearRoute').addEventListener('click', function() {
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
    });
  });
</script>
{% endblock %}
